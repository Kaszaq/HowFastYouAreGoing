package pl.kaszaq.howfastyouaregoing.agile.jira.examples;

import com.mitchtalmadge.asciidata.table.ASCIITable;
import com.mitchtalmadge.asciidata.table.formats.ASCIITableFormat;
import java.time.LocalDate;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import static org.assertj.core.api.Assertions.assertThat;
import org.junit.Test;
import pl.kaszaq.howfastyouaregoing.agile.AgileClient;
import pl.kaszaq.howfastyouaregoing.agile.AgileProject;
import pl.kaszaq.howfastyouaregoing.cfd.CfdData;
import pl.kaszaq.howfastyouaregoing.cfd.CfdDataComputer;
import static pl.kaszaq.howfastyouaregoing.utils.CommonPredicates.alwaysTrue;
import static pl.kaszaq.howfastyouaregoing.utils.DateUtils.printSimpleDate;

public class CfdTest {

    @Test
    public void testSampleCfdCreation() {
        AgileClient agileClient = AgileClientProvider.createClient();

        AgileProject project = agileClient.getAgileProject("AWW");

        CfdData data = CfdDataComputer.calculateCfdData(project, alwaysTrue());

        Map<String, Integer> statusValues = new HashMap<>();
        List<String> statusOrder = project.getProbableStatusOrder();
        statusOrder.forEach(status -> statusValues.put(status, 0));

        String[] headers = new String[statusOrder.size() + 1];
        headers[0] = "Date";
        System.arraycopy(statusOrder.toArray(new String[0]), 0, headers, 1, statusOrder.size());

        int x = statusOrder.size();
        int y = data.getDailyTransitions().size();
        String[][] dataValues = new String[y][x + 1];

        int iy = 0;
        for (Map.Entry<LocalDate, CfdData.DailyStatusChanges> dailyTransition : data.getDailyTransitions().entrySet()) {
            LocalDate k = dailyTransition.getKey();
            CfdData.DailyStatusChanges v = dailyTransition.getValue();
            dataValues[iy][0] = printSimpleDate(k);
            int ix = 1;
            for (String status : statusOrder) {
                Integer newValue = statusValues.merge(status, v.getValueChangeForStatus(status), Integer::sum);
                dataValues[iy][ix] = newValue.toString();
                ix++;
            }
            iy++;
        }

        assertThat(ASCIITable.fromData(headers, dataValues).withTableFormat(new ASCIITableFormat()).toString()).isEqualToIgnoringWhitespace(
                "+============+======+=============+==========+========+==========+ \n"
                + "| Date       | Open | In Progress | Resolved | Closed | Reopened |\n"
                + "|============|======|=============|==========|========|==========|\n"
                + "| 2018-06-22 | 3    | 0           | 0        | 0      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-06-25 | 2    | 1           | 1        | 0      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-06-26 | 3    | 2           | 1        | 0      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-06-27 | 3    | 3           | 1        | 0      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-06-28 | 3    | 1           | 1        | 2      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-06-29 | 0    | 4           | 1        | 1      | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-02 | 2    | 2           | 2        | 2      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-03 | 1    | 3           | 2        | 2      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-04 | 0    | 2           | 3        | 3      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-05 | 1    | 1           | 3        | 4      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-09 | 0    | 2           | 3        | 4      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-11 | 1    | 1           | 3        | 5      | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-12 | 2    | 0           | 4        | 5      | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-13 | 3    | 0           | 3        | 5      | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-16 | 4    | 0           | 3        | 5      | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-17 | 4    | 0           | 5        | 5      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-18 | 3    | 1           | 5        | 5      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-19 | 2    | 0           | 7        | 6      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-20 | 2    | 1           | 7        | 6      | 0        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-23 | 3    | 3           | 6        | 6      | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-24 | 3    | 4           | 5        | 6      | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-25 | 3    | 4           | 5        | 7      | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-26 | 3    | 3           | 6        | 7      | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-27 | 8    | 0           | 6        | 8      | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-30 | 7    | 1           | 6        | 8      | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-07-31 | 10   | 1           | 6        | 8      | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-01 | 10   | 2           | 5        | 8      | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-02 | 11   | 1           | 5        | 9      | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-03 | 8    | 4           | 7        | 9      | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-06 | 4    | 5           | 7        | 10     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-07 | 6    | 5           | 7        | 11     | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-08 | 6    | 5           | 8        | 12     | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-09 | 7    | 5           | 8        | 12     | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-10 | 7    | 5           | 8        | 12     | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-13 | 10   | 2           | 8        | 11     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-14 | 11   | 2           | 8        | 11     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-15 | 14   | 0           | 9        | 12     | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-16 | 13   | 0           | 11       | 14     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-17 | 10   | 2           | 11       | 15     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-20 | 14   | 1           | 11       | 15     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-21 | 11   | 4           | 11       | 15     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-22 | 12   | 4           | 11       | 16     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-23 | 14   | 4           | 11       | 16     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-24 | 16   | 4           | 11       | 16     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-27 | 18   | 4           | 11       | 16     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-28 | 19   | 1           | 12       | 18     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-29 | 16   | 3           | 13       | 18     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-30 | 15   | 3           | 14       | 17     | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-08-31 | 15   | 3           | 16       | 17     | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-03 | 19   | 3           | 15       | 17     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-04 | 18   | 4           | 15       | 18     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-05 | 21   | 4           | 15       | 18     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-06 | 25   | 2           | 15       | 18     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-07 | 25   | 2           | 17       | 18     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-10 | 28   | 1           | 17       | 18     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-11 | 27   | 3           | 17       | 18     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-12 | 27   | 2           | 18       | 18     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-13 | 28   | 2           | 17       | 19     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-14 | 26   | 5           | 17       | 19     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-17 | 25   | 5           | 18       | 20     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-18 | 29   | 3           | 18       | 21     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-19 | 28   | 6           | 18       | 22     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-20 | 30   | 5           | 18       | 22     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-21 | 29   | 7           | 18       | 22     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-24 | 28   | 8           | 18       | 22     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-25 | 27   | 8           | 19       | 22     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-26 | 29   | 6           | 19       | 22     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-27 | 29   | 6           | 19       | 19     | 7        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-09-28 | 31   | 5           | 19       | 20     | 8        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-01 | 34   | 3           | 19       | 21     | 8        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-02 | 34   | 3           | 19       | 20     | 9        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-03 | 34   | 3           | 18       | 21     | 9        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-04 | 32   | 5           | 20       | 21     | 7        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-05 | 35   | 4           | 20       | 22     | 6        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-08 | 35   | 5           | 21       | 22     | 5        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-09 | 34   | 7           | 21       | 24     | 5        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-10 | 37   | 4           | 21       | 26     | 5        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-11 | 40   | 3           | 21       | 27     | 5        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-12 | 42   | 2           | 21       | 27     | 5        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-15 | 43   | 2           | 21       | 27     | 5        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-16 | 43   | 3           | 21       | 27     | 5        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-17 | 43   | 4           | 22       | 28     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-18 | 44   | 4           | 22       | 28     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-19 | 45   | 5           | 22       | 28     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-22 | 46   | 4           | 21       | 28     | 5        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-23 | 46   | 5           | 22       | 28     | 5        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-24 | 44   | 7           | 23       | 28     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-25 | 46   | 5           | 24       | 28     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-26 | 44   | 6           | 24       | 27     | 6        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-29 | 44   | 6           | 25       | 27     | 6        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-30 | 45   | 7           | 27       | 27     | 5        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-10-31 | 45   | 9           | 27       | 27     | 5        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-01 | 46   | 8           | 28       | 27     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-02 | 50   | 5           | 29       | 27     | 4        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-05 | 49   | 5           | 32       | 27     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-06 | 49   | 7           | 32       | 27     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-07 | 51   | 5           | 33       | 27     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-08 | 52   | 5           | 33       | 27     | 3        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-09 | 53   | 4           | 34       | 28     | 2        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-12 | 51   | 6           | 34       | 29     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-13 | 52   | 7           | 34       | 29     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-14 | 51   | 7           | 35       | 30     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-15 | 53   | 4           | 38       | 30     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-16 | 51   | 6           | 38       | 30     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-19 | 52   | 6           | 39       | 30     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-20 | 52   | 8           | 39       | 30     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-21 | 53   | 5           | 41       | 30     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-22 | 58   | 5           | 41       | 30     | 1        |\n"
                + "|------------|------|-------------|----------|--------|----------|\n"
                + "| 2018-11-24 | 59   | 5           | 41       | 30     | 1        |\n"
                + "+============+======+=============+==========+========+==========+");

    }
}
